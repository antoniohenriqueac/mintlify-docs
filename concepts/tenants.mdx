---
title: 'Tenants e Workspaces'
description: 'Entenda o sistema multi-tenant e como funcionam os workspaces no ConnectVets Notes'
---

## O que s√£o Tenants/Workspaces?

**Tenants** (chamados de **Workspaces** no frontend) s√£o espa√ßos isolados onde cada cl√≠nica veterin√°ria gerencia suas consultas, notas e configura√ß√µes de forma independente. √â o n√∫cleo do sistema multi-tenant do ConnectVets Notes.

<Info>
  **Backend** = "Tenant" | **Frontend** = "Workspace"
  
  Ambos se referem ao mesmo conceito: um espa√ßo isolado para uma cl√≠nica veterin√°ria.
</Info>

## Como Funcionam

### Arquitetura Multi-Tenant

```mermaid
graph TB
    Usuario[üë§ Usu√°rio] 
    
    subgraph "Workspaces do Usu√°rio"
        WS1[üè• Cl√≠nica Centro<br/>workspace_001]
        WS2[üè• PetCare Sul<br/>workspace_002] 
        WS3[üè• VetMed Norte<br/>workspace_003]
    end
    
    subgraph "Dados Isolados"
        D1[üìã Notas Centro<br/>üîë API Keys<br/>‚öôÔ∏è Configura√ß√µes]
        D2[üìã Notas PetCare<br/>üîë API Keys<br/>‚öôÔ∏è Configura√ß√µes]
        D3[üìã Notas VetMed<br/>üîë API Keys<br/>‚öôÔ∏è Configura√ß√µes]
    end
    
    Usuario --> WS1
    Usuario --> WS2 
    Usuario --> WS3
    
    WS1 --> D1
    WS2 --> D2
    WS3 --> D3
```

### Isolamento de Dados

Cada workspace mant√©m **dados completamente isolados**:

| Recurso | Escopo | Exemplo |
|---------|--------|---------|
| **Notas** | Por workspace | Consultas da Cl√≠nica Centro ‚â† PetCare |
| **API Keys** | Por workspace | Chave √∫nica para cada cl√≠nica |
| **Configura√ß√µes** | Por workspace | Webhooks, integra√ß√µes pr√≥prias |
| **Usu√°rios** | Por workspace | Veterin√°rios espec√≠ficos da cl√≠nica |
| **Agentes IA** | Por workspace | Treinamentos personalizados |

## Cria√ß√£o de Workspaces

### Interface de Cria√ß√£o

Com base no componente `WorkspaceModal.tsx`:

```javascript
// Estrutura do modal de cria√ß√£o
{
  name: "Nome da Cl√≠nica",        // M√°ximo 32 caracteres
  maxLength: 32,                  // Limite de caracteres
  validation: "required"          // Nome obrigat√≥rio
}
```

### Processo de Cria√ß√£o

<Steps>
  <Step title="Abrir Modal">
    Usu√°rio clica em "Novo Workspace" no painel
  </Step>
  <Step title="Preencher Nome">
    Digite o nome da cl√≠nica (m√°x. 32 caracteres)
  </Step>
  <Step title="Valida√ß√£o">
    Sistema verifica permiss√µes e plano ativo
  </Step>
  <Step title="Cria√ß√£o">
    Novo workspace √© criado e selecionado automaticamente
  </Step>
</Steps>

### Exemplo de Cria√ß√£o via API

```javascript
// Frontend: WorkspaceModal.tsx
const handleSubmit = async (e) => {
  e.preventDefault();
  setLoading(true);
  
  try {
    await createTenant(name);  // createTenant do AuthContext
    setName('');
    onOpenChange(false);
  } catch (err) {
    // Tratamento de erros
    if (err.code === 'forbidden') {
      setError('Voc√™ n√£o tem permiss√£o para criar workspaces, contrate um plano pago!');
    }
  }
};
```

### Restri√ß√µes por Plano

<CardGroup cols={2}>
  <Card
    title="Plano Gratuito"
    icon="free"
  >
    - **1 workspace** inclu√≠do
    - Funcionalidades b√°sicas
    - Limite de notas mensais
    - Sem cria√ß√£o adicional
  </Card>
  
  <Card
    title="Planos Pagos"
    icon="credit-card"
  >
    - **M√∫ltiplos workspaces**
    - Sem limite de cria√ß√£o
    - Funcionalidades avan√ßadas
    - Suporte priorit√°rio
  </Card>
</CardGroup>

## Sele√ß√£o e Troca de Workspaces

### Contexto de Autentica√ß√£o

```javascript
// AuthContext - gerenciamento de tenants
const {
  currentTenant,      // Workspace atualmente selecionado
  tenants,           // Lista de todos os workspaces do usu√°rio
  selectTenant,      // Fun√ß√£o para trocar workspace
  createTenant       // Fun√ß√£o para criar novo workspace
} = useAuth();
```

### Troca de Workspace

```javascript
// Exemplo de troca
const handleWorkspaceChange = (newWorkspaceId) => {
  const selectedWorkspace = tenants.find(t => t.id === newWorkspaceId);
  selectTenant(selectedWorkspace);
  
  // Automaticamente:
  // - Recarrega dados do novo workspace
  // - Atualiza API calls com novo tenant
  // - Redireciona para dashboard do workspace
};
```

### Dropdown de Sele√ß√£o

```javascript
// TenantDropdown.tsx (exemplo conceitual)
<Select onValueChange={handleWorkspaceChange}>
  {tenants.map(tenant => (
    <SelectItem key={tenant.id} value={tenant.id}>
      üè• {tenant.name}
      {tenant.id === currentTenant.id && " (Atual)"}
    </SelectItem>
  ))}
</Select>
```

## Exclus√£o de Workspaces

### Processo de Exclus√£o

Com base no componente `DeleteWorkspaceDialog.tsx`:

<Warning>
  **A√ß√£o Irrevers√≠vel**: A exclus√£o remove **TODOS** os dados do workspace, incluindo notas, configura√ß√µes e agentes IA.
</Warning>

### Confirma√ß√£o por Nome

```javascript
// Prote√ß√£o contra exclus√£o acidental
const confirmationRequired = currentTenant?.name;
const userInput = confirmInput;

// Bot√£o s√≥ habilita quando:
const canDelete = userInput === confirmationRequired;
```

### Fluxo de Exclus√£o

<Steps>
  <Step title="Confirma√ß√£o">
    Usu√°rio deve digitar o **nome exato** do workspace
  </Step>
  <Step title="Valida√ß√£o">
    Sistema confirma que o nome confere
  </Step>
  <Step title="Exclus√£o">
    Remove todos os dados do workspace
  </Step>
  <Step title="Redirecionamento">
    Seleciona outro workspace dispon√≠vel ou redireciona
  </Step>
</Steps>

### Exemplo de Implementa√ß√£o

```javascript
// DeleteWorkspaceDialog.tsx
const handleDelete = async () => {
  setLoading(true);
  
  try {
    // API call para deletar o tenant
    await fetch('/api/tenant', { 
      method: 'DELETE', 
      credentials: 'include' 
    });
    
    // Redireciona para outro workspace se dispon√≠vel
    if (currentTenant && tenants?.length) {
      const remaining = tenants.filter(t => t.id !== currentTenant.id);
      if (remaining.length) {
        selectTenant(remaining[0]);
      }
    }
  } catch (error) {
    console.error('Erro ao deletar workspace:', error);
  }
  
  setLoading(false);
  onOpenChange(false);
};
```

## Integra√ß√£o com API

### Headers de Tenant

Cada requisi√ß√£o √† API identifica o workspace ativo:

```javascript
// Exemplo de requisi√ß√£o
const response = await fetch('/api/notes', {
  headers: {
    'X-API-KEY': workspaceApiKey,           // API Key espec√≠fica do workspace
    'Authorization': `Bearer ${userToken}`, // Token do usu√°rio
    'Content-Type': 'application/json'
  }
});
```

### Isolamento na API

```mermaid
sequenceDiagram
    participant Frontend
    participant API
    participant Auth
    participant DB
    
    Frontend->>API: Request + X-API-KEY
    API->>Auth: Validar API Key
    Auth->>Auth: Identificar Tenant
    Auth->>DB: Query com tenant_id
    DB-->>Auth: Dados do tenant espec√≠fico
    Auth-->>API: Dados filtrados
    API-->>Frontend: Response isolada
```

## Casos de Uso Comuns

### 1. Veterin√°rio com M√∫ltiplas Cl√≠nicas

```javascript
// Configura√ß√£o para veterin√°rio que atende em 3 cl√≠nicas
const veterinarioWorkspaces = [
  {
    id: "ws_001",
    name: "Cl√≠nica Centro Veterin√°rio", 
    role: "admin",
    api_key: "cvn_live_abc123..."
  },
  {
    id: "ws_002", 
    name: "PetCare Zona Sul",
    role: "veterinarian",
    api_key: "cvn_live_def456..."
  },
  {
    id: "ws_003",
    name: "Hospital Veterin√°rio Norte",
    role: "consultant", 
    api_key: "cvn_live_ghi789..."
  }
];
```

### 2. Franquia com M√∫ltiplas Unidades

```javascript
// Gerenciamento de franquia
const franquiaConfig = {
  matriz: {
    name: "VetGroup Matriz",
    settings: {
      canCreateUnits: true,
      centralizedBilling: true,
      sharedTemplates: true
    }
  },
  unidades: [
    { name: "VetGroup Shopping", inheritsFrom: "matriz" },
    { name: "VetGroup Centro", inheritsFrom: "matriz" },
    { name: "VetGroup Barra", inheritsFrom: "matriz" }
  ]
};
```

### 3. Rede de Cl√≠nicas

```javascript
// Configura√ß√£o para rede
const redeClinicas = {
  admin: {
    canAccess: "all_workspaces",
    permissions: ["read", "write", "admin"],
    dashboardView: "consolidated"
  },
  managers: {
    canAccess: "assigned_workspaces", 
    permissions: ["read", "write"],
    dashboardView: "individual"
  },
  veterinarians: {
    canAccess: "single_workspace",
    permissions: ["read"],
    dashboardView: "notes_only"
  }
};
```

## Migra√ß√£o e Backup

### Transfer√™ncia entre Workspaces

<AccordionGroup>
  <Accordion title="Mover Notas">
    ```javascript
    // API para transferir notas entre workspaces
    POST /api/notes/transfer
    {
      "source_tenant_id": "ws_001",
      "target_tenant_id": "ws_002", 
      "note_ids": ["note_123", "note_456"],
      "preserve_metadata": true
    }
    ```
  </Accordion>
  
  <Accordion title="Duplicar Configura√ß√µes">
    ```javascript
    // Copiar configura√ß√µes de um workspace para outro
    POST /api/tenant/duplicate-settings
    {
      "source_tenant_id": "ws_001",
      "target_tenant_id": "ws_002",
      "include": ["webhooks", "api_keys", "templates"]
    }
    ```
  </Accordion>
  
  <Accordion title="Backup Completo">
    ```bash
    # Script para backup de workspace
    curl -H "X-API-KEY: $API_KEY" \
      "https://api.connectvets.com/export/workspace" \
      > backup_workspace_$(date +%Y%m%d).json
    ```
  </Accordion>
</AccordionGroup>

## Monitoramento e Analytics

### M√©tricas por Workspace

```javascript
// Dashboard de m√©tricas
const workspaceMetrics = {
  notes: {
    total: 1247,
    thisMonth: 89,
    avgPerDay: 12.3,
    status: {
      completed: 1180,
      processing: 45, 
      failed: 22
    }
  },
  apiUsage: {
    requestsToday: 342,
    rateLimit: "87% used",
    mostUsedEndpoint: "/notes"
  },
  storage: {
    audioFiles: "2.4 GB",
    textData: "124 MB", 
    totalUsed: "2.5 GB",
    planLimit: "10 GB"
  }
};
```

### Relat√≥rios Consolidados

```javascript
// Para usu√°rios com m√∫ltiplos workspaces
const consolidatedReport = {
  totalWorkspaces: 3,
  totalNotes: 3891,
  totalAPIUsage: 15247,
  topWorkspace: {
    name: "Cl√≠nica Centro",
    notes: 1891,
    growth: "+23% this month"
  },
  alerts: [
    {
      workspace: "PetCare Sul",
      type: "approaching_limit",
      message: "85% do limite de notas atingido"
    }
  ]
};
```

## Seguran√ßa e Permiss√µes

### Controle de Acesso

| N√≠vel | Permiss√µes | Exemplo |
|-------|------------|---------|
| **Owner** | Tudo + delete workspace | Dono da cl√≠nica |
| **Admin** | Gerenciar usu√°rios + configs | Gerente da cl√≠nica |
| **Veterinarian** | Criar/editar notas | Veterin√°rio ativo |
| **Read Only** | Visualizar apenas | Estagi√°rio |

### Auditoria

```javascript
// Log de a√ß√µes por workspace
const auditLog = {
  workspace_id: "ws_001",
  actions: [
    {
      timestamp: "2024-02-14T10:30:00Z",
      user: "dr.silva@clinica.com",
      action: "note_created",
      resource_id: "note_789",
      ip: "192.168.1.100"
    },
    {
      timestamp: "2024-02-14T09:15:00Z", 
      user: "admin@clinica.com",
      action: "user_invited",
      resource_id: "user_456",
      ip: "192.168.1.101"
    }
  ]
};
```

## Troubleshooting

### Problemas Comuns

<AccordionGroup>
  <Accordion title="Erro: Workspace n√£o encontrado">
    **Causa**: Workspace foi deletado ou usu√°rio perdeu acesso
    
    **Solu√ß√£o**:
    ```javascript
    // Verificar workspaces dispon√≠veis
    const availableWorkspaces = await fetchUserWorkspaces();
    if (availableWorkspaces.length === 0) {
      // Redirecionar para cria√ß√£o de workspace
      redirectTo('/workspace/create');
    }
    ```
  </Accordion>
  
  <Accordion title="Dados n√£o aparecem ap√≥s troca">
    **Causa**: Cache n√£o atualizado ou API key incorreta
    
    **Solu√ß√£o**:
    ```javascript
    // For√ßar reload dos dados
    const switchWorkspace = async (newWorkspace) => {
      await selectTenant(newWorkspace);
      await clearCache();
      await reloadData();
    };
    ```
  </Accordion>
  
  <Accordion title="N√£o consegue criar workspace">
    **Causa**: Limita√ß√£o do plano ou permiss√µes
    
    **Solu√ß√£o**:
    - Verificar plano ativo
    - Contatar suporte para upgrade
    - Verificar se atingiu limite do plano
  </Accordion>
</AccordionGroup>

## Usu√°rios Secund√°rios

### Sistema Multi-Usu√°rio por Workspace

Cada workspace pode ter **m√∫ltiplos usu√°rios** trabalhando colaborativamente, dependendo do plano contratado. O sistema permite adicionar **usu√°rios secund√°rios** que compartilham acesso aos dados do workspace.

<Info>
  **Usu√°rios Secund√°rios** s√£o contas adicionais que podem acessar um workspace espec√≠fico, cada uma com suas pr√≥prias credenciais e permiss√µes.
</Info>

### Hierarquia de Usu√°rios

```mermaid
graph TD
    Owner[üëë Owner/Propriet√°rio]
    Admin[üë§ Admin]
    Vet[üë©‚Äç‚öïÔ∏è Veterin√°rio]
    ReadOnly[üëÅÔ∏è Somente Leitura]
    
    Owner --> Admin
    Owner --> Vet
    Owner --> ReadOnly
    
    Admin --> Vet
    Admin --> ReadOnly
    
    Owner -.->|Pode adicionar/remover| Admin
    Owner -.->|Pode adicionar/remover| Vet
    Owner -.->|Pode adicionar/remover| ReadOnly
```

### Limita√ß√µes por Plano

Com base no componente `UsersManager.tsx`:

<CardGroup cols={3}>
  <Card
    title="Plano Individual"
    icon="user"
  >
    - **1 usu√°rio** apenas
    - Funcionalidades b√°sicas
    - Sem usu√°rios secund√°rios
    - Ideal para veterin√°rios aut√¥nomos
  </Card>
  
  <Card
    title="Planos Cl√≠nicas"
    icon="users"
  >
    - **M√∫ltiplos usu√°rios**
    - Limite baseado no plano
    - Colabora√ß√£o em equipe
    - Gerenciamento avan√ßado
  </Card>
  
  <Card
    title="Enterprise Customizado"
    icon="building"
  >
    - **Usu√°rios ilimitados***
    - Configura√ß√£o personalizada
    - Suporte dedicado
    - Integra√ß√£o avan√ßada
  </Card>
</CardGroup>

### Interface de Gerenciamento

```javascript
// Baseado em UsersManager.tsx
const {
  user,           // Usu√°rio atual logado
  currentTenant   // Workspace ativo
} = useAuth();

// Verificar se √© propriet√°rio do workspace
const isOwner = user && currentTenant && user.email === currentTenant.email;

// Dados do plano atual
const subscription = currentTenant.subscription;
const plan = subscription.plan;
const maxUsers = plan.max_users;        // Limite de usu√°rios
const isTrial = plan.type === 'trial';  // Se √© trial
```

### Adi√ß√£o de Usu√°rios Secund√°rios

<Steps>
  <Step title="Verificar Plano">
    Sistema verifica se o plano permite usu√°rios adicionais
  </Step>
  <Step title="Validar Limite">
    Confirma se n√£o atingiu o limite do plano atual
  </Step>
  <Step title="Convidar por Email">
    Owner adiciona email do novo usu√°rio
  </Step>
  <Step title="Valida√ß√£o">
    Sistema verifica se o email existe na plataforma
  </Step>
  <Step title="Acesso Concedido">
    Usu√°rio ganha acesso ao workspace
  </Step>
</Steps>

### Exemplo de Implementa√ß√£o

```javascript
// Processo de adicionar usu√°rio secund√°rio
const handleAddUser = async (email) => {
  // Verificar se atingiu limite do plano
  if (maxUsers !== null && users.length >= maxUsers) {
    toast.error('Limite de usu√°rios atingido pelo seu plano');
    return;
  }
  
  // Verificar se √© plano trial
  if (isTrial) {
    toast.error('Esta fun√ß√£o s√≥ est√° dispon√≠vel para planos pagos');
    return;
  }
  
  try {
    const res = await fetch('/api/tenant', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ email })
    });
    
    if (!res.ok) {
      const data = await res.json();
      if (data.code === 'forbidden') {
        throw new Error('Este usu√°rio n√£o existe, por favor adicione um usu√°rio v√°lido!');
      }
      throw new Error(data.message || 'Erro ao adicionar usu√°rio');
    }
    
    toast.success(`Usu√°rio ${email} adicionado com sucesso!`);
    loadUsers(); // Recarregar lista
    
  } catch (error) {
    toast.error(error.message);
  }
};
```

### Informa√ß√µes dos Usu√°rios

Cada usu√°rio secund√°rio possui:

```typescript
interface TenantUser {
  id: string;                    // ID √∫nico do usu√°rio
  name?: string;                 // Nome completo (opcional)
  email: string;                 // Email (obrigat√≥rio)
  regulatory_doc?: string;       // CRMV ou documento regulat√≥rio
  created_at: string;           // Data de cria√ß√£o
  role?: 'admin' | 'vet' | 'readonly'; // Papel no workspace
}
```

### Exemplo de Lista de Usu√°rios

```javascript
// Interface mostra informa√ß√µes dos usu√°rios
const UserCard = ({ user, isOwner, onDelete }) => (
  <Card className="relative">
    <CardHeader>
      <CardTitle>{user.name || 'Nome n√£o informado'}</CardTitle>
    </CardHeader>
    <CardContent>
      <p>Email: {user.email}</p>
      {user.regulatory_doc && (
        <p>Registro: {user.regulatory_doc}</p>
      )}
      <p>Desde: {format(new Date(user.created_at), "dd 'de' MMMM yyyy")}</p>
    </CardContent>
    
    {/* Bot√£o de exclus√£o apenas para owners */}
    {isOwner && (
      <Button 
        variant="ghost" 
        className="absolute top-2 right-2 text-red-500"
        onClick={() => onDelete(user.id, user.email)}
      >
        <Trash2 className="w-4 h-4" />
      </Button>
    )}
  </Card>
);
```

### Remo√ß√£o de Usu√°rios

Apenas o **propriet√°rio** pode remover usu√°rios secund√°rios:

```javascript
const handleDeleteUser = async (userId, email) => {
  try {
    const res = await fetch('/api/tenant/user', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ user_id: userId })
    });
    
    if (!res.ok) {
      throw new Error('Erro ao remover usu√°rio');
    }
    
    toast.success('Usu√°rio removido com sucesso');
    loadUsers(); // Atualizar lista
    
  } catch (error) {
    toast.error(error.message);
  }
};
```

### Controle de Acesso

<AccordionGroup>
  <Accordion title="Propriet√°rio (Owner)">
    **Permiss√µes completas:**
    - Adicionar/remover usu√°rios secund√°rios
    - Gerenciar configura√ß√µes do workspace
    - Deletar workspace
    - Todas as funcionalidades da plataforma
    
    **Identifica√ß√£o:**
    ```javascript
    const isOwner = user.email === currentTenant.email;
    ```
  </Accordion>
  
  <Accordion title="Usu√°rio Secund√°rio">
    **Permiss√µes limitadas:**
    - Acessar dados do workspace
    - Criar/editar notas (se permitido)
    - Ver relat√≥rios
    - **N√ÉO pode** adicionar outros usu√°rios
    - **N√ÉO pode** deletar workspace
    
    **Controle:**
    ```javascript
    // Bot√µes espec√≠ficos s√≥ aparecem para owners
    {isOwner && (
      <Button onClick={addUser}>Novo Usu√°rio Secund√°rio</Button>
    )}
    ```
  </Accordion>
</AccordionGroup>

### Upgrade de Planos

Para workspaces que atingiram o limite:

```javascript
// Interface de upgrade quando limite atingido
{maxUsers === 1 && (
  <div className="text-blue-600 space-y-1">
    <p>Voc√™ est√° no <strong>Plano Individual</strong>. 
       Deseja adicionar mais usu√°rios √† equipe?</p>
    <Link href="/notes/planos/clinicas" 
          className="bg-blue-600 text-white px-4 py-2 rounded-md">
      Conhe√ßa nossos planos para Cl√≠nicas
    </Link>
  </div>
)}
```

### Contadores de Limite

```javascript
// Exibir uso atual vs limite do plano
const remaining = maxUsers !== null ? maxUsers - users.length : null;

// Interface mostra progresso
<p className="text-sm text-muted-foreground">
  {users.length} de {maxUsers} usu√°rios utilizados
  {remaining === 0 ? ' (limite atingido)' : ''}
</p>
```

### Valida√ß√µes e Restri√ß√µes

<CardGroup cols={2}>
  <Card
    title="Plano Trial"
    icon="clock"
  >
    - **N√£o permite** usu√°rios secund√°rios
    - Mensagem: "Esta fun√ß√£o s√≥ est√° dispon√≠vel para planos pagos"
    - Upgrade necess√°rio
  </Card>
  
  <Card
    title="Limite Atingido"
    icon="ban"
  >
    - Bot√£o "Novo Usu√°rio" **desabilitado**
    - Mensagem: "Limite de usu√°rios atingido pelo seu plano"
    - Sugest√£o de upgrade
  </Card>
</CardGroup>

### API Endpoints para Usu√°rios

```bash
# Listar usu√°rios do workspace
GET /api/tenant/users
Authorization: Bearer {token}

# Adicionar usu√°rio secund√°rio
PUT /api/tenant
Content-Type: application/json
{
  "email": "novo@usuario.com"
}

# Remover usu√°rio secund√°rio  
DELETE /api/tenant/user
Content-Type: application/json
{
  "user_id": "user_12345"
}
```

### Casos de Uso para Usu√°rios Secund√°rios

<AccordionGroup>
  <Accordion title="Cl√≠nica com Equipe">
    ```javascript
    // Exemplo: Cl√≠nica veterin√°ria com m√∫ltiplos profissionais
    const clinicTeam = [
      {
        email: "dr.silva@clinica.com",
        role: "owner",
        name: "Dr. Jo√£o Silva",
        regulatory_doc: "CRMV-SP 12345"
      },
      {
        email: "dra.santos@clinica.com", 
        role: "veterinarian",
        name: "Dra. Maria Santos",
        regulatory_doc: "CRMV-SP 67890"
      },
      {
        email: "recepcao@clinica.com",
        role: "readonly", 
        name: "Ana Recep√ß√£o",
        regulatory_doc: null
      }
    ];
    ```
  </Accordion>
  
  <Accordion title="Franquia Multi-Unidade">
    ```javascript
    // Franquia com gerentes por unidade
    const franchiseStructure = {
      owner: "admin@vetgroup.com",
      units: [
        {
          name: "VetGroup Shopping",
          manager: "manager.shopping@vetgroup.com",
          staff: ["vet1@vetgroup.com", "vet2@vetgroup.com"]
        },
        {
          name: "VetGroup Centro", 
          manager: "manager.centro@vetgroup.com",
          staff: ["vet3@vetgroup.com", "vet4@vetgroup.com"]
        }
      ]
    };
    ```
  </Accordion>
  
  <Accordion title="Hospital Veterin√°rio">
    ```javascript
    // Hospital com diferentes especialidades
    const hospitalTeam = {
      administration: ["admin@hospital.com"],
      veterinarians: [
        "cirurgia@hospital.com",
        "cardiologia@hospital.com", 
        "oncologia@hospital.com"
      ],
      residents: [
        "residente1@hospital.com",
        "residente2@hospital.com"
      ],
      support: ["recepcao@hospital.com"]
    };
    ```
  </Accordion>
</AccordionGroup>

## Sistema de Cobran√ßa e Faturas

### Gest√£o Financeira por Workspace

Cada workspace possui seu pr√≥prio **sistema de cobran√ßa independente**, com assinaturas, faturas e hist√≥rico de pagamentos espec√≠ficos. O sistema integra com o **Stripe** para processamento seguro de pagamentos.

<Info>
  **Cobran√ßa Isolada**: Cada workspace tem sua pr√≥pria assinatura e faturas, permitindo gest√£o financeira independente para cada cl√≠nica.
</Info>

### Estrutura de Assinaturas

Com base no componente de faturas:

```typescript
interface Subscription {
  id: string;                        // ID √∫nico da assinatura
  plan_id: string;                   // ID do plano contratado
  status: string;                    // Status atual (active, canceled, trial, etc.)
  current_period_start: string;      // In√≠cio do per√≠odo atual
  current_period_end: string;        // Fim do per√≠odo (pr√≥xima cobran√ßa)
  cancel_at_period_end: boolean;     // Se ser√° cancelada no fim do per√≠odo
  stripe_subscription_id?: string;   // ID no Stripe
  plan: {
    id: string;
    name: string;                    // Nome do plano
    price: number;                   // Pre√ßo em centavos
    currency: string;                // Moeda (BRL)
    billing_cycle: string;           // Ciclo: 'monthly' ou 'yearly'
  };
}
```

### Status de Assinaturas

<CardGroup cols={2}>
  <Card
    title="Assinaturas Ativas"
    icon="check-circle"
  >
    **Status dispon√≠veis:**
    - `active`: ‚úÖ Ativo e funcionando
    - `trial`: ‚è∞ Per√≠odo de teste
    - `past_due`: ‚ö†Ô∏è Pagamento em atraso
    - `incomplete`: ‚ùå Configura√ß√£o incompleta
  </Card>
  
  <Card
    title="Assinaturas Inativas"
    icon="x-circle"
  >
    **Status de cancelamento:**
    - `canceled`: ‚ùå Cancelada permanentemente
    - `cancel_at_period_end`: üìÖ Cancelar√° no fim do per√≠odo
    - `unpaid`: üí≥ N√£o paga (suspensa)
  </Card>
</CardGroup>

### Interface de Assinaturas

```javascript
// Carregar assinaturas do workspace atual
const loadSubscriptions = async () => {
  const response = await fetch('/api/subscriptions', {
    credentials: 'include',
    cache: 'no-store'
  });
  
  if (response.ok) {
    const subscriptions = await response.json();
    setSubscriptions(subscriptions);
  }
};

// Exibir informa√ß√µes da assinatura
const SubscriptionCard = ({ subscription }) => (
  <Card>
    <CardHeader>
      <CardTitle>{subscription.plan.name}</CardTitle>
      {getStatusBadge(subscription.status)}
    </CardHeader>
    <CardContent>
      <div className="grid grid-cols-3 gap-4">
        {/* Pre√ßo */}
        <div className="flex items-center gap-2">
          <DollarSign className="w-4 h-4" />
          <div>
            <p className="font-medium">
              {formatPrice(subscription.plan.price)}
            </p>
            <p className="text-xs text-muted-foreground">
              por {subscription.plan.billing_cycle === 'monthly' ? 'm√™s' : 'ano'}
            </p>
          </div>
        </div>
        
        {/* Pr√≥xima cobran√ßa */}
        <div className="flex items-center gap-2">
          <Calendar className="w-4 h-4" />
          <div>
            <p className="text-sm font-medium">Pr√≥xima cobran√ßa</p>
            <p className="text-xs text-muted-foreground">
              {formatDate(subscription.current_period_end)}
            </p>
          </div>
        </div>
        
        {/* Cancelamento agendado */}
        {subscription.cancel_at_period_end && (
          <div className="flex items-center gap-2">
            <XCircle className="w-4 h-4 text-destructive" />
            <div>
              <p className="text-sm font-medium text-destructive">
                Ser√° cancelada
              </p>
              <p className="text-xs text-muted-foreground">
                em {formatDate(subscription.current_period_end)}
              </p>
            </div>
          </div>
        )}
      </div>
    </CardContent>
  </Card>
);
```

### Sistema de Faturas

```typescript
interface Invoice {
  id: string;                    // ID √∫nico da fatura
  amount: number;               // Valor em centavos
  currency: string;             // Moeda (BRL)
  status: string;               // Status do pagamento
  paid_at?: string;             // Data do pagamento (se pago)
  due_date: string;             // Data de vencimento
  description?: string;         // Descri√ß√£o da cobran√ßa
  stripe_invoice_id?: string;   // ID no Stripe
}
```

### Status de Faturas

| Status | Descri√ß√£o | √çcone | Cor |
|--------|-----------|-------|-----|
| `paid` | ‚úÖ Pago com sucesso | CheckCircle | Verde |
| `pending` | ‚è≥ Aguardando pagamento | Clock | Amarelo |
| `failed` | ‚ùå Falha no pagamento | XCircle | Vermelho |
| `overdue` | ‚ö†Ô∏è Vencida | AlertCircle | Vermelho |

### Portal de Pagamentos (Stripe)

O sistema integra com o **Stripe Customer Portal** para autoatendimento:

```javascript
// Abrir portal do Stripe para gerenciar pagamentos
const openStripePortal = async () => {
  setPortalLoading(true);
  
  try {
    const response = await fetch('/api/portal_session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        return_url: window.location.origin + '/notes/faturas'
      })
    });
    
    const data = await response.json();
    
    if (data.url) {
      window.open(data.url, '_blank');  // Abre em nova aba
    }
  } catch (error) {
    toast.error('Erro ao abrir portal de pagamentos');
  } finally {
    setPortalLoading(false);
  }
};
```

### Funcionalidades do Portal

<AccordionGroup>
  <Accordion title="Gerenciamento de Assinaturas">
    - **Atualizar m√©todo de pagamento**
    - **Alterar plano** (upgrade/downgrade)
    - **Cancelar assinatura**
    - **Reativar assinatura** cancelada
    - **Visualizar pr√≥ximas cobran√ßas**
  </Accordion>
  
  <Accordion title="Hist√≥rico de Faturas">
    - **Download de faturas** em PDF
    - **Hist√≥rico completo** de pagamentos
    - **Detalhes de cada cobran√ßa**
    - **Comprovantes fiscais**
    - **Segunda via** de faturas
  </Accordion>
  
  <Accordion title="Informa√ß√µes Fiscais">
    - **Dados para nota fiscal**
    - **Endere√ßo de cobran√ßa**
    - **CNPJ/CPF** da cl√≠nica
    - **Configura√ß√µes fiscais**
    - **Prefer√™ncias de entrega**
  </Accordion>
</AccordionGroup>

### Formata√ß√£o de Valores

```javascript
// Converter centavos para reais formatados
const formatPrice = (price, currency = 'BRL') => {
  return (price / 100).toLocaleString('pt-BR', { 
    style: 'currency', 
    currency: currency.toUpperCase() 
  });
};

// Exemplos de formata√ß√£o
formatPrice(2990, 'BRL');  // "R$ 29,90"
formatPrice(9900, 'BRL');  // "R$ 99,00"
formatPrice(19900, 'BRL'); // "R$ 199,00"
```

### Estados da Interface

<CardGroup cols={2}>
  <Card
    title="Sem Assinaturas"
    icon="credit-card"
  >
    ```javascript
    // Estado vazio - nenhuma assinatura
    {subscriptions.length === 0 && (
      <Card>
        <CardContent className="py-8 text-center">
          <CreditCard className="w-12 h-12 mx-auto mb-4 opacity-50" />
          <p>Nenhuma assinatura encontrada</p>
          <Button onClick={() => window.location.href = '/notes/planos'}>
            Conhecer Planos
          </Button>
        </CardContent>
      </Card>
    )}
    ```
  </Card>
  
  <Card
    title="Sem Faturas"
    icon="receipt"
  >
    ```javascript
    // Estado vazio - nenhuma fatura
    {invoices.length === 0 && (
      <Card>
        <CardContent className="py-8 text-center">
          <Receipt className="w-12 h-12 mx-auto mb-4 opacity-50" />
          <p>Nenhuma fatura encontrada</p>
        </CardContent>
      </Card>
    )}
    ```
  </Card>
</CardGroup>

### API Endpoints de Cobran√ßa

```bash
# Listar assinaturas do workspace
GET /api/subscriptions
Authorization: Bearer {token}

# Listar faturas do workspace  
GET /api/invoices
Authorization: Bearer {token}

# Criar sess√£o do portal Stripe
POST /api/portal_session
Content-Type: application/json
{
  "return_url": "https://app.connectvets.com/notes/faturas"
}

# Criar link de checkout para novo plano
POST /api/subscription_link/{tenant_id}/{plan_id}
Authorization: Bearer {token}
```

### Fluxo de Pagamento

```mermaid
sequenceDiagram
    participant User as Usu√°rio
    participant App as ConnectVets App
    participant API as ConnectVets API
    participant Stripe as Stripe
    
    User->>App: Acessa p√°gina de faturas
    App->>API: GET /api/subscriptions
    API-->>App: Lista de assinaturas
    App->>API: GET /api/invoices  
    API-->>App: Hist√≥rico de faturas
    
    User->>App: Clica "Portal de Pagamentos"
    App->>API: POST /api/portal_session
    API->>Stripe: Criar sess√£o do portal
    Stripe-->>API: URL da sess√£o
    API-->>App: URL do portal
    App->>Stripe: Abre portal em nova aba
    
    User->>Stripe: Gerencia pagamentos
    Stripe->>API: Webhook de atualiza√ß√£o
    API->>App: Atualiza dados em tempo real
```

### Exemplo de Uso Completo

```javascript
// Componente completo de gerenciamento financeiro
const FaturasPage = () => {
  const { currentTenant } = useAuth();
  const [subscriptions, setSubscriptions] = useState([]);
  const [invoices, setInvoices] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Carregar dados do workspace atual
  useEffect(() => {
    if (currentTenant) {
      loadFinancialData();
    }
  }, [currentTenant]);
  
  const loadFinancialData = async () => {
    try {
      setLoading(true);
      
      // Carregar em paralelo
      const [subsRes, invoicesRes] = await Promise.all([
        fetch('/api/subscriptions', { credentials: 'include' }),
        fetch('/api/invoices', { credentials: 'include' })
      ]);
      
      if (subsRes.ok) {
        const subsData = await subsRes.json();
        setSubscriptions(subsData);
      }
      
      if (invoicesRes.ok) {
        const invoicesData = await invoicesRes.json();
        setInvoices(invoicesData);
      }
    } catch (error) {
      toast.error('Erro ao carregar dados financeiros');
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="max-w-5xl mx-auto py-10">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-4xl font-semibold">
            Assinaturas e Faturas
          </h1>
          <p className="text-muted-foreground mt-2">
            Gerencie suas assinaturas e visualize suas faturas
          </p>
        </div>
        
        <Button onClick={openStripePortal}>
          <ExternalLink className="w-4 h-4 mr-2" />
          Portal de Pagamentos
        </Button>
      </div>
      
      {/* Se√ß√£o de assinaturas */}
      <SubscriptionsSection subscriptions={subscriptions} />
      
      {/* Se√ß√£o de faturas */}
      <InvoicesSection invoices={invoices} />
    </div>
  );
};
```

### Notifica√ß√µes e Alertas

```javascript
// Sistema de notifica√ß√µes para eventos de cobran√ßa
const NotificationSystem = {
  paymentSuccess: (amount) => {
    toast.success(`Pagamento de ${formatPrice(amount)} processado com sucesso!`);
  },
  
  paymentFailed: (amount) => {
    toast.error(`Falha no pagamento de ${formatPrice(amount)}. Verifique seu m√©todo de pagamento.`);
  },
  
  subscriptionCanceled: (planName) => {
    toast.warning(`Assinatura ${planName} foi cancelada e expirar√° no final do per√≠odo.`);
  },
  
  trialEnding: (daysLeft) => {
    toast.info(`Seu per√≠odo de teste expira em ${daysLeft} dias. Assine um plano para continuar.`);
  }
};
```

## Pr√≥ximos Passos

<CardGroup cols={2}>
  <Card
    title="API Keys"
    icon="key"
    href="/concepts/api-keys"
  >
    Como funcionam as chaves por workspace
  </Card>
  <Card
    title="Autentica√ß√£o"
    icon="shield"
    href="/authentication"
  >
    Implementar auth multi-tenant
  </Card>
  <Card
    title="Gerenciar Tenants"
    icon="settings"
    href="/api-reference/tenants/list"
  >
    Endpoints para workspaces
  </Card>
  <Card
    title="Conceitos - Notas"
    icon="note"
    href="/concepts/notes"
  >
    Como as notas funcionam por workspace
  </Card>
</CardGroup> 